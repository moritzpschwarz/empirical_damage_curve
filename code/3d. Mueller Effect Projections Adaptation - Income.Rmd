---
title: "Mueller et al Projection"
subtitle: "Income Adaptation"
author: "Moritz Schwarz and Felix Pretis"
version: "October 2020"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = here::here("output")) })
---

```{r,purl = FALSE}
knitr::opts_chunk$set(message = F,echo = T,fig.width = 10)
```

```{r "setup", message=FALSE}
library(tidyverse)
library(data.table)
library(gets)
library(here)
library(vroom)
library(MASS)

library(extrafont)
library(RColorBrewer)
library(Cairo)
library(viridis)


rm(list = ls())
select <- dplyr::select
```

**To create Server Script: Save first then**

```{r,eval= TRUE, purl = FALSE}
knitr::purl(here("code","6. Mueller Effect Projections Adaptation - realisations.Rmd"),output = here("code","6. Server_Mueller_Adaptation.R"))
```

# Load Mueller at el data

```{r}
mueller <- readxl::read_excel(here("data","raw","Predictive_ Distributions_by_Country.xlsx"),
                              skip = 6,col_names = c("iso","empty1","value_2017","empty2","fifty_mean","fifty_0.05",
                                                     "fifty_0.16","fifty_0.5","fifty_0.84","fifty_0.95", "empty3","hundred_mean","hundred_0.05",
                                                     "hundred_0.16","hundred_0.5","hundred_0.84","hundred_0.95", "empty4","unknown")) %>% select(-contains("empty"))

mueller_mean <- mueller %>% 
  select(iso, value_2017, contains("mean"))

mueller_mean %>% 
  mutate(year = 2017,
         gdp_cap = exp(value_2017),
         gdp_cap_fifty = gdp_cap,
         gdp_cap_fifty_climate = gdp_cap_fifty,
         gdp_cap_hundred = gdp_cap,
         gdp_cap_hundred_climate = gdp_cap_hundred,
         fifty_mean = (fifty_mean/100)+1,
         hundred_mean = (hundred_mean/100)+1,
         value_2017 = NULL,
         gdp_cap = NULL) %>% 
  select(iso,year,gdp_cap_fifty, gdp_cap_hundred,everything()) -> mueller_df
```

## Prepare the Max GDP Restriction

Here we identify the 2017 Level of GDP that will act as our restriction.

```{r}
base_gdp <- mueller_df %>% filter(year==2017) %>% 
  select(iso,gdp_cap_fifty,gdp_cap_hundred) %>% 
  rename(base_fifty = gdp_cap_fifty,
         base_hundred = gdp_cap_hundred)

restrict_max_gdp_int = TRUE
```

# Adaptation GETS

## Load Coefficients

### Standard (for restriction)

```{r}
load(here("data","temp","standard_gets_model.RData"))
####simulate coefficients, draw them form joint normal distribution
set.seed(123)
selection_coefs_standard <- MASS::mvrnorm(n = coefsamples, mu = standard_model %>% coef(), Sigma = standard_model %>% vcov()) %>%
  {if (is.vector(.)) t(.) else .} %>%
  data.frame() %>%
  rename_all(~ tolower(.)) %>%
  select(-l1.diff.ln_gdp_cap, -starts_with(c("year", "iis", "time", "iso"))) %>%
  rename_all(~ paste0(., "_coef"))

# If we are just using one coefsample, we simply use the mean estimate from the model
if(coefsamples==1){
  standard_model %>%
    coef %>%
    data.frame(variable = names(.),
               coefficient = .,
               row.names = NULL) %>%
    pivot_wider(names_from = "variable",values_from = "coefficient") %>%
    rename_all(~tolower(.)) %>%
    select(-l1.diff.ln_gdp_cap,-starts_with(c("year","iis","time","iso"))) %>% 
    rename_all(~paste0(.,"_coef")) -> selection_coefs_standard
}
```

### Log Interaction All

```{r}
load(here("data","temp","log_interaction_model_all.RData"))

####simulate coefficients, draw them form joint normal distribution
set.seed(123)
selection_coefs_interaction_all_log <- MASS::mvrnorm(n = coefsamples, mu = interaction_model_all_log %>% coef(), Sigma = interaction_model_all_log %>% vcov()) %>%
  {if (is.vector(.)) t(.) else .} %>%
  data.frame() %>%
  rename_all(~ tolower(.)) %>%
  select(-l1.diff.ln_gdp_cap, -starts_with(c("year", "iis", "time", "iso"))) %>%
  rename_all(~ paste0(., "_coef"))

if(coefsamples==1){
  interaction_model_all_log %>%
    coef %>%
    data.frame(variable = names(.),
               coefficient = .,
               row.names = NULL) %>%
    pivot_wider(names_from = "variable",values_from = "coefficient") %>%
    rename_all(~tolower(.)) %>%
    select(-l1.diff.ln_gdp_cap,-starts_with(c("year","iis","time","iso"))) %>% 
    rename_all(~paste0(.,"_coef")) -> selection_coefs_interaction_all_log
}
```

### Log Interaction Selected

```{r}
load(here("data","temp","log_interaction_model_selected.RData"))

####simulate coefficients, draw them form joint normal distribution
set.seed(123)
selection_coefs_interaction_selected_log <- MASS::mvrnorm(n = coefsamples, mu = interaction_model_selected_log %>% coef(), Sigma = interaction_model_selected_log %>% vcov()) %>%
  {if (is.vector(.)) t(.) else .} %>%
  data.frame() %>%
  rename_all(~ tolower(.)) %>%
  select(-l1.diff.ln_gdp_cap, -starts_with(c("year", "iis", "time", "iso"))) %>%
  rename_all(~ paste0(., "_coef"))

if(coefsamples==1){
  interaction_model_selected_log %>%
    coef %>%
    data.frame(variable = names(.),
               coefficient = .,
               row.names = NULL) %>%
    pivot_wider(names_from = "variable",values_from = "coefficient") %>%
    rename_all(~tolower(.)) %>%
    select(-l1.diff.ln_gdp_cap,-starts_with(c("year","iis","time","iso"))) %>% 
    rename_all(~paste0(.,"_coef")) -> selection_coefs_interaction_selected_log
}
```

## Collect Relevant Information

```{r}
selection_coefs_standard %>% 
  names %>% 
  gsub("_coef","",.) %>% 
  unique -> climate_vars

selection_coefs_standard %>% 
  names %>% 
  gsub("_coef|_2","",.) %>% 
  unique -> climate_vars_lin

selection_coefs_standard %>% 
  names %>% 
  grep("_2",.,value = TRUE) %>% 
  gsub("_coef|_2","",.) %>% 
  unique -> climate_vars_sq

selection_coefs_interaction_all_log %>% 
  names %>% 
  gsub("_coef","",.) %>% 
  grep("_int",.,value = TRUE) %>% 
  gsub("_int","",.) %>% 
  unique -> interaction_vars_all

selection_coefs_interaction_selected_log %>%
  names %>%
  gsub("_coef","",.) %>%
  grep("_int",.,value = TRUE) %>%
  gsub("_int","",.) %>%
  unique -> interaction_vars_selected
```

## Load climate data

```{r}
climate <- vroom(here("data","temp","corrected_anomaly_climatedata.csv"))
climate %>% 
  select(model,rcp,ensemble,final_temp,iso,year,all_of(climate_vars_lin),
         all_of(paste0(climate_vars_sq,"_2"))) %>% 
  drop_na -> climate_subset
#mutate(across(.cols = climate_vars_sq,.fns = list(`2` = ~.^2))) -> climate_subset
rm(climate)
```

# Unrestricted

## Project (Server)

```{r}
library(doMC)
registerDoMC(if(coefsamples < detectCores()){coefsamples} else {detectCores()-1})  # coefsamples if enough cores available - otherwise total-1
foreach(v=1:coefsamples,.packages = loadedNamespaces()) %dopar% {
  #for (v in 1:coefsamples){
  print(v)
  
  effect_interaction_selected_log <- climate_subset
  # Calculate the climate effect
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  for(var in interaction_vars_selected){
    effect_interaction_selected_log %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_int_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_int_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  # Calculate the standard climate effect
  effect_standard <- climate_subset
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_standard %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_standard,.) -> effect_standard
  }
  
  effect_standard %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","stdeffect",.)) -> effect_std
  
  effect_interaction_selected_log %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","logeffect",.)) %>% 
    bind_cols(effect_std %>% select(contains("stdeffect"))) -> effect_int
  
  done <- mueller_df %>% 
    select(-contains("fifty")) %>% 
    filter(year==2017) %>% 
    left_join(effect_int %>% 
                filter(year == 2017) %>% 
                select(-model,-ensemble),by = c("iso","year")) %>% 
    
    #drop_na %>% 
    mutate(realisation = v) %>% 
    relocate(c(realisation,final_temp), .after = year)
  
  for(i in 2018:2099){
    print(paste0("Realisation ",v," Year: ",i))
    #i=2018
    
    done %>% 
      filter(year == i-1) %>% 
      select(iso, year, final_temp, realisation, contains(c("hundred"))) %>% 
      left_join(effect_int %>% 
                  filter(year == i-1) %>% 
                  mutate(realisation = v) %>% 
                  select(-model,-ensemble,-rcp),by = c("iso","year","final_temp","realisation")) %>% 
      
      mutate(#gdp_cap_fifty = gdp_cap_fifty*fifty_mean,
        gdp_cap_hundred = gdp_cap_hundred*hundred_mean) %>% 
      
      mutate(total_stdeffect = rowSums(select(.,contains("stdeffect"))),
             
             total_climlogeffect = rowSums(select(.,contains("logeffect"),-contains("_int_"))),
             total_inteffect =  rowSums(select(.,contains("_int_logeffect")))) %>% 
      
      mutate(#interaction_effect_fifty = total_climlogeffect + total_inteffect*log(gdp_cap_fifty_climate),
        interaction_effect_hundred = total_climlogeffect + total_inteffect*log(gdp_cap_hundred_climate)) %>% 
      
      mutate(#total_effect_this_year_fifty = ifelse(total_stdeffect > interaction_effect_fifty,
        #                                     total_stdeffect,
        #                                    interaction_effect_fifty),
        total_effect_this_year_hundred = ifelse(total_stdeffect > interaction_effect_hundred,
                                                total_stdeffect,
                                                interaction_effect_hundred)) %>%
      
      mutate(#gdp_cap_fifty_climate = gdp_cap_fifty_climate * (fifty_mean + total_effect_this_year_fifty),
        gdp_cap_hundred_climate = gdp_cap_hundred_climate*(hundred_mean + total_effect_this_year_hundred)) %>%
      
      mutate(year = i) %>% 
      
      #select(-starts_with("total_")) %>% 
      
      bind_rows(done,.) -> done
    
  }
  
  
  save(done,file = here("data","temp","projections",
                        paste0("full_Mueller_interaction_log_selected_unrestricted_",v,".RData")))
  rm(done,i)
}
```

# Restriction Max Overall GDP

**October 2020** Not used anymore.

<!-- ```{r} -->

<!-- base_gdp_2017 <- mueller_df %>% select(iso,gdp_cap_fifty) %>% rename(base_value_2017 = gdp_cap_fifty) -->

<!-- max_overall_gdp <- max(base_gdp$base_fifty) -->

<!-- ``` -->

<!-- ## Project (Server) -->

<!-- ```{r} -->

<!-- library(doMC) -->

<!-- registerDoMC(if(coefsamples < detectCores()){coefsamples} else {detectCores()-1})  # coefsamples if enough cores available - otherwise total-1 -->

<!-- foreach(v=1:coefsamples,.packages = loadedNamespaces()) %dopar% { -->

<!--   #for (v in 1:coefsamples){ -->

<!--   print(v) -->

<!--   effect_interaction_selected_log <- climate_subset -->

<!--   # Calculate the climate effect -->

<!--   for(var in climate_vars){ -->

<!--     #print(var) -->

<!--     climate_subset %>%  -->

<!--       select(all_of(var)) %>%  -->

<!--       pull %>% "*"(selection_coefs_interaction_selected_log %>%  -->

<!--                      slice(v) %>%  -->

<!--                      select(all_of(paste0(var,"_coef"))) %>%  -->

<!--                      pull) %>% -->

<!--       as_tibble %>%  -->

<!--       rename_all(~paste0(var,"_effect"))  %>%  -->

<!--       bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log -->

<!--   } -->

<!--   for(var in interaction_vars_selected){ -->

<!--     effect_interaction_selected_log %>%  -->

<!--       select(all_of(var)) %>%  -->

<!--       pull %>% "*"(selection_coefs_interaction_selected_log %>%  -->

<!--                      slice(v) %>%  -->

<!--                      select(all_of(paste0(var,"_int_coef"))) %>%  -->

<!--                      pull) %>% -->

<!--       as_tibble %>%  -->

<!--       rename_all(~paste0(var,"_int_effect"))  %>%  -->

<!--       bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log -->

<!--   } -->

<!--   # Calculate the standard climate effect -->

<!--   effect_standard <- climate_subset -->

<!--   for(var in climate_vars){ -->

<!--     #print(var) -->

<!--     climate_subset %>%  -->

<!--       select(all_of(var)) %>%  -->

<!--       pull %>% "*"(selection_coefs_standard %>%  -->

<!--                      slice(v) %>%  -->

<!--                      select(all_of(paste0(var,"_coef"))) %>%  -->

<!--                      pull) %>% -->

<!--       as_tibble %>%  -->

<!--       rename_all(~paste0(var,"_effect"))  %>%  -->

<!--       bind_cols(effect_standard,.) -> effect_standard -->

<!--   } -->

<!--   effect_standard %>%  -->

<!--     rename_with(.cols = contains("effect"),.fn = ~gsub("effect","stdeffect",.)) -> effect_std -->

<!--   effect_interaction_selected_log %>%  -->

<!--     rename_with(.cols = contains("effect"),.fn = ~gsub("effect","logeffect",.)) %>%  -->

<!--     bind_cols(effect_std %>% select(contains("stdeffect"))) -> effect_int -->

<!--   done <- mueller_df %>%  -->

<!--     select(-contains("fifty")) %>%  -->

<!--     filter(year==2017) %>%  -->

<!--     left_join(effect_int %>%  -->

<!--                 filter(year == 2017) %>%  -->

<!--                 select(-model,-ensemble),by = c("iso","year")) %>%  -->

<!--     #drop_na %>%  -->

<!--     mutate(realisation = v) %>%  -->

<!--     relocate(c(realisation,final_temp), .after = year) -->

<!--   for(i in 2018:2099){ -->

<!--     print(paste0("Realisation ",v," Year: ",i)) -->

<!--     #i=2018 -->

<!--     done %>%  -->

<!--       filter(year == i-1) %>%  -->

<!--       select(iso, year, final_temp, realisation, contains(c("hundred")),-contains("base")) %>%  -->

<!--       left_join(effect_int %>%  -->

<!--                   filter(year == i-1) %>%  -->

<!--                   mutate(realisation = v) %>%  -->

<!--                   select(-model,-ensemble,-rcp),by = c("iso","year","final_temp","realisation")) %>%  -->

<!--       mutate(#gdp_cap_fifty = gdp_cap_fifty*fifty_mean, -->

<!--         gdp_cap_hundred = gdp_cap_hundred*hundred_mean) %>%  -->

<!--       mutate(total_stdeffect = rowSums(select(.,contains("stdeffect"))), -->

<!--              total_climlogeffect = rowSums(select(.,contains("logeffect"),-contains("_int_"))), -->

<!--              total_inteffect =  rowSums(select(.,contains("_int_logeffect")))) %>%  -->

<!--       mutate(#interaction_effect_fifty = total_climlogeffect + total_inteffect*log( -->

<!--         #ifelse(gdp_cap_fifty_climate>max_overall_gdp, -->

<!--         #      max_overall_gdp, -->

<!--         #     gdp_cap_fifty_climate)), -->

<!--         interaction_effect_hundred = total_climlogeffect + total_inteffect*log( -->

<!--           ifelse(gdp_cap_hundred_climate>max_overall_gdp, -->

<!--                  max_overall_gdp, -->

<!--                  gdp_cap_hundred_climate))) %>%  -->

<!--       mutate(#total_effect_this_year_fifty = ifelse(total_stdeffect > interaction_effect_fifty, -->

<!--         #                                      total_stdeffect, -->

<!--         #                                      interaction_effect_fifty), -->

<!--         total_effect_this_year_hundred = ifelse(total_stdeffect > interaction_effect_hundred, -->

<!--                                                 total_stdeffect, -->

<!--                                                 interaction_effect_hundred)) %>% -->

<!--       mutate(#gdp_cap_fifty_climate = gdp_cap_fifty_climate * (fifty_mean + total_effect_this_year_fifty), -->

<!--         gdp_cap_hundred_climate = gdp_cap_hundred_climate*(hundred_mean + total_effect_this_year_hundred)) %>% -->

<!--       mutate(year = i) %>%  -->

<!--       #select(-starts_with("total_")) %>%  -->

<!--       bind_rows(done,.) -> done -->

<!--   } -->

<!--   save(done,file = here("data","temp","projections", -->

<!--                         paste0("full_Mueller_interaction_log_selected_restricted_",v,".RData"))) -->

<!--   rm(done,i) -->

<!-- } -->

<!-- ``` -->

# Alternative Restriction 1: Baseline Restriction and Max GDP

Idea: Because we are only attenuating the effect of climate change, when the standard effect would suggest that GDP decreases, the Adaptation equivalent can only increase by a maximum of the baseline.

Option 1: if country would lose, best could do is baseline. Combined: can do no worse than the no-adaptation baseline, but if the signs don't agree can't do better than baseline growth

```{r}
base_gdp_2017 <- mueller_df %>% select(iso,gdp_cap_fifty) %>% rename(base_value_2017 = gdp_cap_fifty)
max_overall_gdp <- max(base_gdp$base_fifty)
```

## Project (Server)

```{r}
library(doMC)
registerDoMC(if(coefsamples < detectCores()){coefsamples} else {detectCores()-1})  # coefsamples if enough cores available - otherwise total-1
foreach(v=1:coefsamples,.packages = loadedNamespaces()) %dopar% {
  #for (v in 1:coefsamples){
  print(v)
  
  effect_interaction_selected_log <- climate_subset
  # Calculate the climate effect
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  for(var in interaction_vars_selected){
    effect_interaction_selected_log %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_int_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_int_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  # Calculate the standard climate effect
  effect_standard <- climate_subset
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_standard %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_standard,.) -> effect_standard
  }
  
  effect_standard %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","stdeffect",.)) -> effect_std
  
  effect_interaction_selected_log %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","logeffect",.)) %>% 
    bind_cols(effect_std %>% select(contains("stdeffect"))) -> effect_int
  
  done <- mueller_df %>% 
    select(-contains("fifty")) %>% 
    filter(year==2017) %>% 
    left_join(effect_int %>% 
                filter(year == 2017) %>% 
                select(-model,-ensemble),by = c("iso","year")) %>% 
    
    #drop_na %>% 
    mutate(realisation = v) %>% 
    relocate(c(realisation,final_temp), .after = year)
  
  for(i in 2018:2099){
    print(paste0("Realisation ",v," Year: ",i))
    #i=2018
    
    done %>% 
      filter(year == i-1) %>% 
      select(iso, year, final_temp, realisation, contains(c("hundred")),-contains("base")) %>% 
      left_join(effect_int %>% 
                  filter(year == i-1) %>% 
                  mutate(realisation = v) %>% 
                  select(-model,-ensemble,-rcp),by = c("iso","year","final_temp","realisation")) %>% 
      
      mutate(#gdp_cap_fifty = gdp_cap_fifty*fifty_mean,
        gdp_cap_hundred = gdp_cap_hundred*hundred_mean) %>% 
      
      mutate(total_stdeffect = rowSums(select(.,contains("stdeffect"))),
             
             total_climlogeffect = rowSums(select(.,contains("logeffect"),-contains("_int_"))),
             total_inteffect =  rowSums(select(.,contains("_int_logeffect")))) %>% 
      
      # max GDP Restriction
      mutate(interaction_effect_hundred = total_climlogeffect + total_inteffect*log( 
        
        ifelse(gdp_cap_hundred_climate>max_overall_gdp,
               max_overall_gdp,
               gdp_cap_hundred_climate))) %>%
      
      
      mutate(total_effect_this_year_hundred = ifelse(total_stdeffect > interaction_effect_hundred,
                                                     total_stdeffect,
                                                     interaction_effect_hundred))   %>% 
      
      
      # in words: if there is a sign difference, take take the smaller of the interaction or the base effect
      mutate(gdp_cap_hundred_climate = gdp_cap_hundred_climate* 
               ifelse(
                 test = sign(total_stdeffect)==-1 & sign(interaction_effect_hundred)==1, # if sign between stdeffect != interaction 
                 yes = ifelse(hundred_mean<(total_effect_this_year_hundred+1),hundred_mean,(total_effect_this_year_hundred+1)),
                 no = hundred_mean + total_effect_this_year_hundred
               )
      ) %>% 
      
      mutate(year = i) %>% 
      
      bind_rows(done,.) -> done
    
  }
  

  save(done,file = here("data","temp","projections",
                        paste0("full_Mueller_interaction_log_selected_altrestr1_",v,".RData")))
  rm(done,i)
}
```

# Alternative Restriction 2: Baseline Restriction

## Project (Server)

```{r}
library(doMC)
registerDoMC(if(coefsamples < detectCores()){coefsamples} else {detectCores()-1})  # coefsamples if enough cores available - otherwise total-1
foreach(v=1:coefsamples,.packages = loadedNamespaces()) %dopar% {
  #for (v in 1:coefsamples){
  print(v)
  
  effect_interaction_selected_log <- climate_subset
  # Calculate the climate effect
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  for(var in interaction_vars_selected){
    effect_interaction_selected_log %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_int_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_int_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  # Calculate the standard climate effect
  effect_standard <- climate_subset
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_standard %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_standard,.) -> effect_standard
  }
  
  effect_standard %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","stdeffect",.)) -> effect_std
  
  effect_interaction_selected_log %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","logeffect",.)) %>% 
    bind_cols(effect_std %>% select(contains("stdeffect"))) -> effect_int
  
  done <- mueller_df %>% 
    select(-contains("fifty")) %>% 
    filter(year==2017) %>% 
    left_join(effect_int %>% 
                filter(year == 2017) %>% 
                select(-model,-ensemble),by = c("iso","year")) %>% 
    
    #drop_na %>% 
    mutate(realisation = v) %>% 
    relocate(c(realisation,final_temp), .after = year)
  
  for(i in 2018:2099){
    print(paste0("Realisation ",v," Year: ",i))
    #i=2018
    
    done %>% 
      filter(year == i-1) %>% 
      select(iso, year, final_temp, realisation, contains(c("hundred")),-contains("base")) %>% 
      left_join(effect_int %>% 
                  filter(year == i-1) %>% 
                  mutate(realisation = v) %>% 
                  select(-model,-ensemble,-rcp),by = c("iso","year","final_temp","realisation")) %>% 
      
      mutate(#gdp_cap_fifty = gdp_cap_fifty*fifty_mean,
        gdp_cap_hundred = gdp_cap_hundred*hundred_mean) %>% 
      
      mutate(total_stdeffect = rowSums(select(.,contains("stdeffect"))),
             
             total_climlogeffect = rowSums(select(.,contains("logeffect"),-contains("_int_"))),
             total_inteffect =  rowSums(select(.,contains("_int_logeffect")))) %>% 
      
      # No max GDP Restriction
      mutate(interaction_effect_hundred = total_climlogeffect + total_inteffect*log(gdp_cap_hundred_climate)) %>%
      
      
      mutate(total_effect_this_year_hundred = ifelse(total_stdeffect > interaction_effect_hundred,
                                                     total_stdeffect,
                                                     interaction_effect_hundred))   %>% 
      
      
      # in words: if there is a sign difference, take take the smaller of the interaction or the base effect
      mutate(gdp_cap_hundred_climate = gdp_cap_hundred_climate* 
               ifelse(
                 test = sign(total_stdeffect)==-1 & sign(interaction_effect_hundred)==1, # if sign between stdeffect != interaction 
                 yes = ifelse(hundred_mean<(total_effect_this_year_hundred+1),hundred_mean,(total_effect_this_year_hundred+1)),
                 no = hundred_mean + total_effect_this_year_hundred
               )
      ) %>% 
      
      
      mutate(year = i) %>% 
      
      bind_rows(done,.) -> done
    
  }
  
  save(done,file = here("data","temp","projections",
                        paste0("full_Mueller_interaction_log_selected_altrestr2_",v,".RData")))
  rm(done,i)
}
```

# Adaptation LASSO

## Load Coefficients

### Standard (for restriction)

```{r}
load(here("data","temp","standard_lasso_model.RData"))
####simulate coefficients, draw them form joint normal distribution
set.seed(123)
selection_coefs_standard <- MASS::mvrnorm(n = coefsamples, mu = lasso_standard_model %>% coef(), Sigma = lasso_standard_model %>% vcov()) %>%
  {if (is.vector(.)) t(.) else .} %>%
  data.frame() %>%
  rename_all(~ tolower(.)) %>%
  select(-l1.diff.ln_gdp_cap, -starts_with(c("year", "iis", "time", "iso"))) %>%
  rename_all(~ paste0(., "_coef"))

# If we are just using one coefsample, we simply use the mean estimate from the model
if(coefsamples==1){
  lasso_standard_model %>%
    coef %>%
    data.frame(variable = names(.),
               coefficient = .,
               row.names = NULL) %>%
    pivot_wider(names_from = "variable",values_from = "coefficient") %>%
    rename_all(~tolower(.)) %>%
    select(-l1.diff.ln_gdp_cap,-starts_with(c("year","iis","time","iso"))) %>% 
    rename_all(~paste0(.,"_coef")) -> selection_coefs_standard
}
```

### Log Interaction All

```{r}
load(here("data","temp","lasso_log_interaction_model_all.RData"))

####simulate coefficients, draw them form joint normal distribution
set.seed(123)
selection_coefs_interaction_all_log <- MASS::mvrnorm(n = coefsamples, mu = lasso_interaction_model_all_log %>% coef(), Sigma = lasso_interaction_model_all_log %>% vcov()) %>%
  {if (is.vector(.)) t(.) else .} %>%
  data.frame() %>%
  rename_all(~ tolower(.)) %>%
  select(-l1.diff.ln_gdp_cap, -starts_with(c("year", "iis", "time", "iso"))) %>%
  rename_all(~ paste0(., "_coef"))

if(coefsamples==1){
  lasso_interaction_model_all_log %>%
    coef %>%
    data.frame(variable = names(.),
               coefficient = .,
               row.names = NULL) %>%
    pivot_wider(names_from = "variable",values_from = "coefficient") %>%
    rename_all(~tolower(.)) %>%
    select(-l1.diff.ln_gdp_cap,-starts_with(c("year","iis","time","iso"))) %>% 
    rename_all(~paste0(.,"_coef")) -> selection_coefs_interaction_all_log
}
```

### Log Interaction Selected

```{r}
load(here("data","temp","lasso_log_interaction_model_selected.RData"))

####simulate coefficients, draw them form joint normal distribution
set.seed(123)
selection_coefs_interaction_selected_log <- MASS::mvrnorm(n = coefsamples, mu = lasso_interaction_model_selected_log %>% coef(), Sigma = lasso_interaction_model_selected_log %>% vcov()) %>%
  {if (is.vector(.)) t(.) else .} %>%
  data.frame() %>%
  rename_all(~ tolower(.)) %>%
  select(-l1.diff.ln_gdp_cap, -starts_with(c("year", "iis", "time", "iso"))) %>%
  rename_all(~ paste0(., "_coef"))

if(coefsamples==1){
  lasso_interaction_model_selected_log %>%
    coef %>%
    data.frame(variable = names(.),
               coefficient = .,
               row.names = NULL) %>%
    pivot_wider(names_from = "variable",values_from = "coefficient") %>%
    rename_all(~tolower(.)) %>%
    select(-l1.diff.ln_gdp_cap,-starts_with(c("year","iis","time","iso"))) %>% 
    rename_all(~paste0(.,"_coef")) -> selection_coefs_interaction_selected_log
}
```

## Collect Relevant Information

```{r}
selection_coefs_standard %>% 
  names %>% 
  gsub("_coef","",.) %>% 
  unique -> climate_vars

selection_coefs_standard %>% 
  names %>% 
  gsub("_coef|_2","",.) %>% 
  unique -> climate_vars_lin

selection_coefs_standard %>% 
  names %>% 
  grep("_2",.,value = TRUE) %>% 
  gsub("_coef|_2","",.) %>% 
  unique -> climate_vars_sq

selection_coefs_interaction_all_log %>% 
  names %>% 
  gsub("_coef","",.) %>% 
  grep("_int",.,value = TRUE) %>% 
  gsub("_int","",.) %>% 
  unique -> interaction_vars_all

selection_coefs_interaction_selected_log %>%
  names %>%
  gsub("_coef","",.) %>%
  grep("_int",.,value = TRUE) %>%
  gsub("_int","",.) %>%
  unique -> interaction_vars_selected
```

## Load climate data

```{r}
climate <- vroom(here("data","temp","corrected_anomaly_climatedata.csv"))
climate %>% 
  select(model,rcp,ensemble,final_temp,iso,year,all_of(climate_vars_lin),
         all_of(paste0(climate_vars_sq,"_2"))) %>% 
  drop_na -> climate_subset
#mutate(across(.cols = climate_vars_sq,.fns = list(`2` = ~.^2))) -> climate_subset
rm(climate)
```

# Unrestricted

## Project (Server)

```{r}
library(doMC)
registerDoMC(if(coefsamples < detectCores()){coefsamples} else {detectCores()-1})  # coefsamples if enough cores available - otherwise total-1
foreach(v=1:coefsamples,.packages = loadedNamespaces()) %dopar% {
  #for (v in 1:coefsamples){
  print(v)
  
  effect_interaction_selected_log <- climate_subset
  # Calculate the climate effect
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  for(var in interaction_vars_selected){
    effect_interaction_selected_log %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_int_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_int_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  # Calculate the standard climate effect
  effect_standard <- climate_subset
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_standard %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_standard,.) -> effect_standard
  }
  
  effect_standard %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","stdeffect",.)) -> effect_std
  
  effect_interaction_selected_log %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","logeffect",.)) %>% 
    bind_cols(effect_std %>% select(contains("stdeffect"))) -> effect_int
  
  done <- mueller_df %>% 
    select(-contains("fifty")) %>% 
    filter(year==2017) %>% 
    left_join(effect_int %>% 
                filter(year == 2017) %>% 
                select(-model,-ensemble),by = c("iso","year")) %>% 
    
    #drop_na %>% 
    mutate(realisation = v) %>% 
    relocate(c(realisation,final_temp), .after = year)
  
  for(i in 2018:2099){
    print(paste0("Realisation ",v," Year: ",i))
    #i=2018
    
    done %>% 
      filter(year == i-1) %>% 
      select(iso, year, final_temp, realisation, contains(c("hundred"))) %>% 
      left_join(effect_int %>% 
                  filter(year == i-1) %>% 
                  mutate(realisation = v) %>% 
                  select(-model,-ensemble,-rcp),by = c("iso","year","final_temp","realisation")) %>% 
      
      mutate(#gdp_cap_fifty = gdp_cap_fifty*fifty_mean,
        gdp_cap_hundred = gdp_cap_hundred*hundred_mean) %>% 
      
      mutate(total_stdeffect = rowSums(select(.,contains("stdeffect"))),
             
             total_climlogeffect = rowSums(select(.,contains("logeffect"),-contains("_int_"))),
             total_inteffect =  rowSums(select(.,contains("_int_logeffect")))) %>% 
      
      mutate(#interaction_effect_fifty = total_climlogeffect + total_inteffect*log(gdp_cap_fifty_climate),
        interaction_effect_hundred = total_climlogeffect + total_inteffect*log(gdp_cap_hundred_climate)) %>% 
      
      mutate(#total_effect_this_year_fifty = ifelse(total_stdeffect > interaction_effect_fifty,
        #                                     total_stdeffect,
        #                                    interaction_effect_fifty),
        total_effect_this_year_hundred = ifelse(total_stdeffect > interaction_effect_hundred,
                                                total_stdeffect,
                                                interaction_effect_hundred)) %>%
      
      mutate(#gdp_cap_fifty_climate = gdp_cap_fifty_climate * (fifty_mean + total_effect_this_year_fifty),
        gdp_cap_hundred_climate = gdp_cap_hundred_climate*(hundred_mean + total_effect_this_year_hundred)) %>%
      
      mutate(year = i) %>% 
      
      #select(-starts_with("total_")) %>% 
      
      bind_rows(done,.) -> done
    
  }
  
  save(done,file = here("data","temp","projections",
                        paste0("full_Mueller_lasso_interaction_log_selected_unrestricted_",v,".RData")))
  rm(done,i)
}
```



# Restriction Max Overall GDP

**October 2020** Not used anymore.

<!-- ```{r} -->
<!-- base_gdp_2017 <- mueller_df %>% select(iso,gdp_cap_fifty) %>% rename(base_value_2017 = gdp_cap_fifty) -->
<!-- max_overall_gdp <- max(base_gdp$base_fifty) -->
<!-- ``` -->

<!-- ## Project (Server) -->

<!-- ```{r} -->
<!-- library(doMC) -->
<!-- registerDoMC(if(coefsamples < detectCores()){coefsamples} else {detectCores()-1})  # coefsamples if enough cores available - otherwise total-1 -->
<!-- foreach(v=1:coefsamples,.packages = loadedNamespaces()) %dopar% { -->
<!--   #for (v in 1:coefsamples){ -->
<!--   print(v) -->

<!--   effect_interaction_selected_log <- climate_subset -->
<!--   # Calculate the climate effect -->
<!--   for(var in climate_vars){ -->
<!--     #print(var) -->
<!--     climate_subset %>%  -->
<!--       select(all_of(var)) %>%  -->
<!--       pull %>% "*"(selection_coefs_interaction_selected_log %>%  -->
<!--                      slice(v) %>%  -->
<!--                      select(all_of(paste0(var,"_coef"))) %>%  -->
<!--                      pull) %>% -->
<!--       as_tibble %>%  -->
<!--       rename_all(~paste0(var,"_effect"))  %>%  -->
<!--       bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log -->
<!--   } -->

<!--   for(var in interaction_vars_selected){ -->
<!--     effect_interaction_selected_log %>%  -->
<!--       select(all_of(var)) %>%  -->
<!--       pull %>% "*"(selection_coefs_interaction_selected_log %>%  -->
<!--                      slice(v) %>%  -->
<!--                      select(all_of(paste0(var,"_int_coef"))) %>%  -->
<!--                      pull) %>% -->
<!--       as_tibble %>%  -->
<!--       rename_all(~paste0(var,"_int_effect"))  %>%  -->
<!--       bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log -->
<!--   } -->

<!--   # Calculate the standard climate effect -->
<!--   effect_standard <- climate_subset -->
<!--   for(var in climate_vars){ -->
<!--     #print(var) -->
<!--     climate_subset %>%  -->
<!--       select(all_of(var)) %>%  -->
<!--       pull %>% "*"(selection_coefs_standard %>%  -->
<!--                      slice(v) %>%  -->
<!--                      select(all_of(paste0(var,"_coef"))) %>%  -->
<!--                      pull) %>% -->
<!--       as_tibble %>%  -->
<!--       rename_all(~paste0(var,"_effect"))  %>%  -->
<!--       bind_cols(effect_standard,.) -> effect_standard -->
<!--   } -->

<!--   effect_standard %>%  -->
<!--     rename_with(.cols = contains("effect"),.fn = ~gsub("effect","stdeffect",.)) -> effect_std -->

<!--   effect_interaction_selected_log %>%  -->
<!--     rename_with(.cols = contains("effect"),.fn = ~gsub("effect","logeffect",.)) %>%  -->
<!--     bind_cols(effect_std %>% select(contains("stdeffect"))) -> effect_int -->

<!--   done <- mueller_df %>%  -->
<!--     select(-contains("fifty")) %>%  -->
<!--     filter(year==2017) %>%  -->
<!--     left_join(effect_int %>%  -->
<!--                 filter(year == 2017) %>%  -->
<!--                 select(-model,-ensemble),by = c("iso","year")) %>%  -->

<!--     #drop_na %>%  -->
<!--     mutate(realisation = v) %>%  -->
<!--     relocate(c(realisation,final_temp), .after = year) -->

<!--   for(i in 2018:2099){ -->
<!--     print(paste0("Realisation ",v," Year: ",i)) -->
<!--     #i=2018 -->

<!--     done %>%  -->
<!--       filter(year == i-1) %>%  -->
<!--       select(iso, year, final_temp, realisation, contains(c("hundred")),-contains("base")) %>%  -->
<!--       left_join(effect_int %>%  -->
<!--                   filter(year == i-1) %>%  -->
<!--                   mutate(realisation = v) %>%  -->
<!--                   select(-model,-ensemble,-rcp),by = c("iso","year","final_temp","realisation")) %>%  -->

<!--       mutate(#gdp_cap_fifty = gdp_cap_fifty*fifty_mean, -->
<!--         gdp_cap_hundred = gdp_cap_hundred*hundred_mean) %>%  -->

<!--       mutate(total_stdeffect = rowSums(select(.,contains("stdeffect"))), -->

<!--              total_climlogeffect = rowSums(select(.,contains("logeffect"),-contains("_int_"))), -->
<!--              total_inteffect =  rowSums(select(.,contains("_int_logeffect")))) %>%  -->

<!--       mutate(#interaction_effect_fifty = total_climlogeffect + total_inteffect*log( -->
<!--         #ifelse(gdp_cap_fifty_climate>max_overall_gdp, -->
<!--         #      max_overall_gdp, -->
<!--         #     gdp_cap_fifty_climate)), -->
<!--         interaction_effect_hundred = total_climlogeffect + total_inteffect*log( -->
<!--           ifelse(gdp_cap_hundred_climate>max_overall_gdp, -->
<!--                  max_overall_gdp, -->
<!--                  gdp_cap_hundred_climate))) %>%  -->

<!--       mutate(#total_effect_this_year_fifty = ifelse(total_stdeffect > interaction_effect_fifty, -->
<!--         #                                      total_stdeffect, -->
<!--         #                                      interaction_effect_fifty), -->
<!--         total_effect_this_year_hundred = ifelse(total_stdeffect > interaction_effect_hundred, -->
<!--                                                 total_stdeffect, -->
<!--                                                 interaction_effect_hundred)) %>% -->

<!--       mutate(#gdp_cap_fifty_climate = gdp_cap_fifty_climate * (fifty_mean + total_effect_this_year_fifty), -->
<!--         gdp_cap_hundred_climate = gdp_cap_hundred_climate*(hundred_mean + total_effect_this_year_hundred)) %>% -->

<!--       mutate(year = i) %>%  -->

<!--       #select(-starts_with("total_")) %>%  -->

<!--       bind_rows(done,.) -> done -->

<!--   } -->

<!--   save(done,file = here("data","temp","projections", -->
<!--                         paste0("full_Mueller_lasso_interaction_log_selected_restricted_",v,".RData"))) -->
<!--   rm(done,i) -->
<!-- } -->
<!-- ``` -->



# Alternative Restriction 1: Baseline Restriction and Max GDP

Idea: Because we are only attenuating the effect of climate change, when the standard effect would suggest that GDP decreases, the Adaptation equivalent can only increase by a maximum of the baseline.

Option 1: if country would lose, best could do is baseline. Combined: can do no worse than the no-adaptation baseline, but if the signs don't agree can't do better than baseline growth

```{r}
base_gdp_2017 <- mueller_df %>% select(iso,gdp_cap_fifty) %>% rename(base_value_2017 = gdp_cap_fifty)
max_overall_gdp <- max(base_gdp$base_fifty)
```

## Project (Server)

```{r}
library(doMC)
registerDoMC(if(coefsamples < detectCores()){coefsamples} else {detectCores()-1})  # coefsamples if enough cores available - otherwise total-1
foreach(v=1:coefsamples,.packages = loadedNamespaces()) %dopar% {
  #for (v in 1:coefsamples){
  print(v)
  
  effect_interaction_selected_log <- climate_subset
  # Calculate the climate effect
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  for(var in interaction_vars_selected){
    effect_interaction_selected_log %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_int_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_int_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  # Calculate the standard climate effect
  effect_standard <- climate_subset
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_standard %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_standard,.) -> effect_standard
  }
  
  effect_standard %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","stdeffect",.)) -> effect_std
  
  effect_interaction_selected_log %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","logeffect",.)) %>% 
    bind_cols(effect_std %>% select(contains("stdeffect"))) -> effect_int
  
  done <- mueller_df %>% 
    select(-contains("fifty")) %>% 
    filter(year==2017) %>% 
    left_join(effect_int %>% 
                filter(year == 2017) %>% 
                select(-model,-ensemble),by = c("iso","year")) %>% 
    
    #drop_na %>% 
    mutate(realisation = v) %>% 
    relocate(c(realisation,final_temp), .after = year)
  
  for(i in 2018:2099){
    print(paste0("Realisation ",v," Year: ",i))
    #i=2018
    
    done %>% 
      filter(year == i-1) %>% 
      select(iso, year, final_temp, realisation, contains(c("hundred")),-contains("base")) %>% 
      left_join(effect_int %>% 
                  filter(year == i-1) %>% 
                  mutate(realisation = v) %>% 
                  select(-model,-ensemble,-rcp),by = c("iso","year","final_temp","realisation")) %>% 
      
      mutate(#gdp_cap_fifty = gdp_cap_fifty*fifty_mean,
        gdp_cap_hundred = gdp_cap_hundred*hundred_mean) %>% 
      
      mutate(total_stdeffect = rowSums(select(.,contains("stdeffect"))),
             
             total_climlogeffect = rowSums(select(.,contains("logeffect"),-contains("_int_"))),
             total_inteffect =  rowSums(select(.,contains("_int_logeffect")))) %>% 
      
      # max GDP Restriction
      mutate(interaction_effect_hundred = total_climlogeffect + total_inteffect*log( 
        
        ifelse(gdp_cap_hundred_climate>max_overall_gdp,
               max_overall_gdp,
               gdp_cap_hundred_climate))) %>%
      
      
      mutate(total_effect_this_year_hundred = ifelse(total_stdeffect > interaction_effect_hundred,
                                                     total_stdeffect,
                                                     interaction_effect_hundred))   %>% 
      
      
      # in words: if there is a sign difference, take take the smaller of the interaction or the base effect
      mutate(gdp_cap_hundred_climate = gdp_cap_hundred_climate* 
               ifelse(
                 test = sign(total_stdeffect)==-1 & sign(interaction_effect_hundred)==1, # if sign between stdeffect != interaction 
                 yes = ifelse(hundred_mean<(total_effect_this_year_hundred+1),hundred_mean,(total_effect_this_year_hundred+1)),
                 no = hundred_mean + total_effect_this_year_hundred
               )
      ) %>% 
      
      mutate(year = i) %>% 
      
      bind_rows(done,.) -> done
    
  }
  
  save(done,file = here("data","temp","projections",
                        paste0("full_Mueller_lasso_interaction_log_selected_altrestr1_",v,".RData")))
  rm(done,i)
}
```

# Alternative Restriction 2: Baseline Restriction

## Project (Server)

```{r}
library(doMC)
registerDoMC(if(coefsamples < detectCores()){coefsamples} else {detectCores()-1})  # coefsamples if enough cores available - otherwise total-1
foreach(v=1:coefsamples,.packages = loadedNamespaces()) %dopar% {
  #for (v in 1:coefsamples){
  print(v)
  
  effect_interaction_selected_log <- climate_subset
  # Calculate the climate effect
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  for(var in interaction_vars_selected){
    effect_interaction_selected_log %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_interaction_selected_log %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_int_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_int_effect"))  %>% 
      bind_cols(effect_interaction_selected_log,.) -> effect_interaction_selected_log
  }
  
  # Calculate the standard climate effect
  effect_standard <- climate_subset
  for(var in climate_vars){
    #print(var)
    climate_subset %>% 
      select(all_of(var)) %>% 
      pull %>% "*"(selection_coefs_standard %>% 
                     slice(v) %>% 
                     select(all_of(paste0(var,"_coef"))) %>% 
                     pull) %>%
      as_tibble %>% 
      rename_all(~paste0(var,"_effect"))  %>% 
      bind_cols(effect_standard,.) -> effect_standard
  }
  
  effect_standard %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","stdeffect",.)) -> effect_std
  
  effect_interaction_selected_log %>% 
    rename_with(.cols = contains("effect"),.fn = ~gsub("effect","logeffect",.)) %>% 
    bind_cols(effect_std %>% select(contains("stdeffect"))) -> effect_int
  
  done <- mueller_df %>% 
    select(-contains("fifty")) %>% 
    filter(year==2017) %>% 
    left_join(effect_int %>% 
                filter(year == 2017) %>% 
                select(-model,-ensemble),by = c("iso","year")) %>% 
    
    #drop_na %>% 
    mutate(realisation = v) %>% 
    relocate(c(realisation,final_temp), .after = year)
  
  for(i in 2018:2099){
    print(paste0("Realisation ",v," Year: ",i))
    #i=2018
    
    done %>% 
      filter(year == i-1) %>% 
      select(iso, year, final_temp, realisation, contains(c("hundred")),-contains("base")) %>% 
      left_join(effect_int %>% 
                  filter(year == i-1) %>% 
                  mutate(realisation = v) %>% 
                  select(-model,-ensemble,-rcp),by = c("iso","year","final_temp","realisation")) %>% 
      
      mutate(#gdp_cap_fifty = gdp_cap_fifty*fifty_mean,
        gdp_cap_hundred = gdp_cap_hundred*hundred_mean) %>% 
      
      mutate(total_stdeffect = rowSums(select(.,contains("stdeffect"))),
             
             total_climlogeffect = rowSums(select(.,contains("logeffect"),-contains("_int_"))),
             total_inteffect =  rowSums(select(.,contains("_int_logeffect")))) %>% 
      
      # No max GDP Restriction
      mutate(interaction_effect_hundred = total_climlogeffect + total_inteffect*log(gdp_cap_hundred_climate)) %>%
      
      
      mutate(total_effect_this_year_hundred = ifelse(total_stdeffect > interaction_effect_hundred,
                                                     total_stdeffect,
                                                     interaction_effect_hundred))   %>% 
      
      
      # in words: if there is a sign difference, take take the smaller of the interaction or the base effect
      mutate(gdp_cap_hundred_climate = gdp_cap_hundred_climate* 
               ifelse(
                 test = sign(total_stdeffect)==-1 & sign(interaction_effect_hundred)==1, # if sign between stdeffect != interaction 
                 yes = ifelse(hundred_mean<(total_effect_this_year_hundred+1),hundred_mean,(total_effect_this_year_hundred+1)),
                 no = hundred_mean + total_effect_this_year_hundred
               )
      ) %>% 
      
      
      mutate(year = i) %>% 
      
      bind_rows(done,.) -> done
    
  }
  
  save(done,file = here("data","temp","projections",
                        paste0("full_Mueller_lasso_interaction_log_selected_altrestr2_",v,".RData")))
  rm(done,i)
}
```
